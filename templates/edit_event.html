{% extends 'base.html' %}

{% block title %}Edit Event{% endblock %}

{% block head %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
{% endblock %}

{% block content %}
<main>
    <!-- Navigate to tab -->
    <div class="tab-container">
        <button class="tab-button" onclick="openTab(event, 'editEvent')" id="defaultOpen">EDIT EVENT</button>
        <button class="tab-button" onclick="openTab(event, 'previewEvent')">PREVIEW EVENT</button>
    </div>

    <!-- Edit Event -->
    <div id="editEvent" class="tab-content">
        <div class="create-event-container">
            <form class="create-event-form" method="POST" enctype="multipart/form-data">
                {{ form.hidden_tag() }}
                <h1>Edit Event</h1>
                <h2>Event Details</h2>
                <div class="ce-form-group">
                    {{ form.event_name.label }} 
                    {{ form.event_name() }}
                </div>
                <div class="ce-form-group">
                    {{ form.event_cat.label }}
                    {{ form.event_cat() }}
                </div>
                <div class="ce-flex-group">
                    <div class="ce-form-group">
                        {{ form.event_start.label }}
                        {{ form.event_start() }}
                    </div>
                    <div class="ce-form-group">
                        {{ form.event_end.label }}
                        {{ form.event_end() }}
                    </div>
                </div>
                <div class="ce-flex-group">
                    <div class="ce-form-group">
                        {{ form.event_time.label }}
                        {{ form.event_time() }}
                    </div>
                    <div class="ce-form-group">
                        {{ form.duration.label }}
                        {{ form.duration(value=event.event_duration) }}
                    </div>
                </div>
                <div class="ce-form-group">
                    {{ form.event_img.label }}
                    {{ form.event_img() }}
                </div>
                <div class="form-group">
                    {{ form.event_descr.label }}
                    {{ form.event_descr(cols=40, rows=5) }}
                </div>
    
                <h2>Event Location</h2>
                <div class="ce-form-group">
                    {{ form.event_venue.label }}
                    {{ form.event_venue() }}
                </div>
                <div class="ce-form-group">
                    {{ form.location_detail.label }}
                    {{ form.location_detail(value=event.location_details) }}
                </div>
    
                <h2>Ticket Setup</h2>
                <table class="add-ticket" id="tickets-table">
                    <thead>
                        <tr>
                            <th>Ticket Type</th>
                            <th>Price (RM)</th>
                            <th>Member Price (RM)</th>
                            <th>Quantity</th>
                            <th>Start Sale</th>
                            <th>End Sale</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="tickets-tbody">
                        {% for ticket in form.tickets %}
                        <tr>
                            <td>{{ ticket.hidden_tag() }} {{ ticket.ticket_type() }}</td>
                            <td>{{ ticket.price() }}</td>
                            <td>{{ ticket.member_discount() }}</td>
                            <td>{{ ticket.max_quantity() }}</td>
                            <td>{{ ticket.start_sale() }}</td>
                            <td>{{ ticket.end_sale() }}</td>
                            <td><button type="button" onclick="removeTicketRow(this)">Remove</button></td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
                <button type="button" onclick="addTicketRow()">Add Ticket</button>
    
                <script>
                    function addTicketRow() {
                        const tbody = document.getElementById('tickets-tbody');
                        const index = tbody.children.length;
    
                        const row = document.createElement('tr');
    
                        row.innerHTML = `
                            <td><input type="hidden" name="tickets-${index}-csrf_token" value="{{ csrf_token() }}"><input type="text" name="tickets-${index}-ticket_type" required></td>
                            <td><input type="number" step="0.01" name="tickets-${index}-price" required></td>
                            <td><input type="number" step="0.01" name="tickets-${index}-member_discount" required></td>
                            <td><input type="number" name="tickets-${index}-max_quantity" required></td>
                            <td><input type="date" name="tickets-${index}-start_sale" required></td>
                            <td><input type="date" name="tickets-${index}-end_sale"></td>
                            <td><button type="button" onclick="removeTicketRow(this)">Remove</button></td>
                        `;
    
                        tbody.appendChild(row);
                    }
    
                    function removeTicketRow(button) {
                        const row = button.closest('tr');
                        row.remove();
                    }
                </script>
                
                <br><br><br>
                
                <div class="ce-flex-group">
                    <div class="ce-form-group">
                        <button type="submit" name="action" value="delete" formnovalidate="formnovalidate" 
                        onclick="return confirm('Are you sure you want to delete this event?');">Delete Event</button>
                    </div>
                    <div class="ce-form-group">
                        <button type="submit" name="action" value="update">Save Changes</button>
                    </div>
                </div>
                
                <button type="submit" name="action" value="edit-publish" 
                onclick="return confirm('Are you sure you want to publish this event? ');">Publish Event</button>
            </form>
        </div>
    </div>

    <!-- Preview Event -->
    <div id="previewEvent" class="tab-content">
        <div class="create-event-container">
            <form class="create-event-form">
                <h1 style="font-size: 40px">{{ event.event_name }}</h1>
                <div class="poster-container">
                    <div class="poster-background-blur" style="background-image: url('{{ url_for('static', filename='images/' ~ (event.event_img or 'default_poster.png')) }}');"></div>
                    <img src="{{ url_for('static', filename='images/' ~ (event.event_img or 'default_poster.png')) }}" alt="Event Image" class="poster-foreground-image">
                </div>
                <div class="event-detail-container">
                    <div class="event-section">
                        <table class="event-display">
                            <tr>
                                <th>Organiser</th>
                                <td>{{ event.admin.admin_name }}</td>
                            </tr>
                            <tr>
                                <th>Location/Platform</th>
                                <td>{{ event.location_details }}</td>
                            </tr>
                            <tr>
                                <th>Date</th>
                                <td>{{ event.event_start }} - {{ event.event_end }}</td>
                            </tr>
                            <tr>
                                <th>Start Time</th>
                                <td>{{ event.event_time }}</td>
                            </tr>
                            <tr>
                                <th>Duration</th>
                                <td>{{ event.event_duration }}</td>
                            </tr>
                        </table>
                        <h2>About this event</h2>
                        <table>
                            <tr>
                                <td>{{ event.event_descr }}</td>
                            </tr>
                        </table>
                    </div>
                    <br><br>
                    <div class="ticket-section">
                        <h2>Tickets</h2>
                        <!-- Display tickets -->
                        {% for ticket in event.tickets %}
                        <div class="ticket-container">
                            <div class="ticket-detail">
                                <h3>{{ ticket.ticket_type }}</h3>
                                <div class="prices">
                                    <label for="normal-price">Normal Price: </label>
                                    <label for="normal-price">RM {{ ticket.price }}</label>
                                </div>
                                <div class="prices">
                                    <label for="member-price">Member Price: </label>
                                    <label for="member-price">RM {{ ticket.member_discount }}</label>
                                </div>
                            </div>
                            
                            <div class="quantity-select">
                                <select id="quantity">
                                    <option value="0">0</option>
                                    <option value="1">1</option>
                                </select>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                    <br><br><br>
                    <button class="purchase-ticket" id="purchaseTicketButton" onclick="purchaseTicket()" disabled>Purchase Ticket</button>
                </div>
            </form>
        </div>
    </div>

    <!-- javascript to manage tabbed navigation -->
    <script>
        function openTab(evt, tabName) {
            var i, tabcontent, tablinks;
            tabcontent = document.getElementsByClassName("tab-content");
            for (i = 0; i < tabcontent.length; i++) {
                tabcontent[i].style.display = "none";
            }
            tablinks = document.getElementsByClassName("tab-button");
            for (i = 0; i < tablinks.length; i++) {
                tablinks[i].className = tablinks[i].className.replace(" active", "");
            }
            document.getElementById(tabName).style.display = "block";
            evt.currentTarget.className += " active";
        }

        document.getElementById("defaultOpen").click();
    </script>
</main>
{% endblock %}
